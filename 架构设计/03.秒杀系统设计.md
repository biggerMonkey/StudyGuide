## 秒杀架构

高性能、一致性、高可用

设计原则：

**数据尽量少、请求数尽量少、路径尽量短、依赖尽量少，并且不要有单点**

数据尽量少：前端请求后端的数据，尽可能少，尤其是需要和数据库打交道的数据，数据越大，网络消耗越大

请求数要尽量少：前端请求后端的次数尽量少，有些能够合并的请求尽量合并，一个大接口返回比多个小接口返回，效果更好，次数越多，网络消耗越大

路径要尽量短：就是用户发出请求到返回数据这个过程中，需求经过的中间的节点数：

前端缓存>CDN缓存>网关缓存(nginx)>内存缓存(guava/caffeine)>中间件缓存(redis)>持久化存储(mysql)



用户登陆校验

对统一用户进行限流，防止被刷，保证一个用户一个请求/s

根据商品Id进行hash分桶，不同的商品id，消息队列处理分开



默认配置：线程数 = 2 * CPU 核数 + 1

最佳实践得出来的公式：线程数 = [(线程等待时间 + 线程 CPU 时间) / 线程 CPU 时间] × CPU 数量

最好的办法是通过性能测试来发现最佳的线程数



## 1 synchronized 加锁 

| 线程数 | 失败率  | 平均 | 最大值 | 最小值 |
| ------ | ------- | ---- | ------ | ------ |
| 1000   | 0       | 1323 | 2102   | 10     |
| 5000   | 0.74665 | 1490 | 8483   | 0      |
|        |         |      |        |        |